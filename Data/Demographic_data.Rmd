---
title: "Demographic Data (for 2/27 presentation)"
author: "Practicum Team: Watauga"
date: "2024-02-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Library}
#install.packages("FedData")
#install.packages("animation")
#install.packages("rasterVis")

library(FedData)
library(tidyverse)
library(tidycensus)
library(sf)
library(dplyr)
library(raster) 
library(rgdal)
library(animation)
library(rasterVis)
library(RColorBrewer) 
library(ggplot2)      
library(colorspace)
library(dplyr)
library(tidyr)
library(readr)
library(sf)
library(terra)
library(kableExtra)

color_palette <- c("#e2a334", "#f9bf3e", "#fcd977", "#9ad7d2", "#74c1b9")
```
# Write up

## Problem Statement / Use Case

Watauga County, North Carolina, is currently experiencing a housing shortage that is expected to intensify in the near future. The shortage is exacerbated by vacation rentals and student housing, which has significantly reduced the available residential housing options. The Watauga Housing Solutions Committee is partnering with other community and local government organizations looking to develop affordable and workforce housing in order to mitigate the severe decreases in housing affordability. They are working with a developer to prioritize the most feasible sites to pursue for purchase and development. Because of the extreme physical conditions of the landscape (slope, soils, etc.) there is currently no streamlined system in place to help identify suitable parcels for development. In response to this issue, we have been contracted to develop an application-based data framework that is designed to identify land parcels based on their likelihood to be developed for affordable and workforce housing.  This data framework will be designed to function as an interactive application interface that will allow users to input criteria related to land supply and combine it with development likelihood estimates to rank each parcel in the county in terms of suitability.

## Project Client:

The main project client is the Watauga Housing Council and its Housing Solutions Committee. This organization is tasked with responding to the economic, environmental, and social aspects of the county to provide adequate housing options for all residents. our main points of contacts within the housing council are Dr. Kellie Reed Ashcraft, Facilitator/Organizer, Watauga Housing Council, Dr. Chris Quattro, Assistant Professor, Appalachian State University/Member, Watauga Housing Council , Laura Beach, Member, Watauga Housing Council. 

## Dependent Variable: Septic System Permits 
The key indicator for development (dependent variable) that will be used is the administrative record associated with septic system permits. This permit is exclusively granted when a property satisfies the requirements for both land supply and developer demand at that specific site. Due to the rural nature of the project area, there is relatively low wastewater sewer coverage. subsequently, a septic system is critical for new development, and a site cannot be developed without one. Our approach will involve identifying the site suitability characteristics (e.g., slope, soils) most closely related to the probability of a parcel receiving a septic permit. Using this information, we will forecast the likelihood that a given parcel will receive a new septic permit. 

## Demographic Data

### Number of Households by Number of Vehicles Owned
While nearly every household in Watauga owns at least one car, it is most common for household to have two.  When observed in connection to household size of ~2.30, this suggests that each person has access to their own car. Watauga is a car-centered community, and individual motorized transit is the standard.

## Population
In 2017, Watauga County was home to 53,421 people. Increasing to 54,540 by 2022, the County is showing steady increases in population over the last 5 years. As more people call the County home, it is increasingly important for the Housing Council to address future housing needs.

## Household Size
In 2017, the median household size in Watauga County was 2.35. Decreasing slightly in 2022 at 2.30, household size largely mirrors those of surrounding counties, which all experience households of approximately 2-3 people.  This suggests that many homes in the area are families, rather than just individuals or couples living together.

## Housing by Occupancy Type (Own vs. Rent)
As of 2022, approximately two-thirds of homes in the County are owner-occupied (61%). When considered alongside the large youth and student population associated with Appalachian State, it becomes clearer that most adults without association to the university are homeowners.

## Median Income
In 2022, Watauga County saw a median household income of $50,034. This is on par with the surrounding counties of Ashe, Avery, Caldwell, and Wilkes, which fell within $3,000 of this range.  ($49,176-$53,313). The area experiences relatively low incomes, compared to the national median of $74,580.

## Median Age
Watauga's median age has increased sharply over the last five years. In 2017, the median age was 30.6, rising 1.5 years to 32.1 in 2022. However, Watauga remains significantly younger than the surrounding area, which tends towards the mid/upper 40s, likely due to the strong student population.

## Rent Burden
A household is considered rent burdened if they spend more than 30% of their monthly income on housing. This metric is key in determining the financial health of the residents, as well as current conditions of the housing market. Northwest North Carolina has been trending lower in rent burden, with many counties seeing a decrease in burden over the last five years. However, the story is different when it comes to Watauga, which has seen an uptick in rent burden since 2017. 

Currently, more than two-thirds of residents are rent burdened, signaling an unstable housing market. This is a key indicator for our project's use case, as the County continues to search for solutions for making housing more affordable and accessible for its residents and families.

## House Price / Ownership Burden

## Student Population
Within Watauga County sits Appalachian State University, a public four-year university that serves over 18,000 students. The surge of student populations is felt throughout Boone and surrounding areas, and plays a large role in the County's economy. As of 2022, ~30% of Watauga's population was college students, a slight increase in the last five years. When planning for existing and future housing needs, the Housing Council should consider the student population, as well as housing that can continue to provide as graduates settle elsewhere in the County and find jobs.


# Data Wrangling

## Number of Households by Number of Vehicles Owned
```{r vehicles_owned}
county17 <- 
  get_acs(geography = "county", 
          variables = c("B08201_002",
                        "B08201_003",
                        "B08201_004",
                        "B08201_005",
                        "B08201_006"), 
          year=2017, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename("No Vehicle" = B08201_002E,
         "1 Vehicle" = B08201_003E,
         "2 Vehicles" = B08201_004E,
         "3 Vehicles" = B08201_005E,
         "4+ Vehicles" = B08201_006E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County", "Caldwell County")) %>%
  dplyr::select(GEOID, NAME, "No Vehicle", "1 Vehicle", "2 Vehicles", "3 Vehicles", "4+ Vehicles")

county22 <- 
  get_acs(geography = "county", 
          variables = c("B08201_002",
                        "B08201_003",
                        "B08201_004",
                        "B08201_005",
                        "B08201_006"), 
          year=2022, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename("No Vehicle" = B08201_002E,
         "1 Vehicle" = B08201_003E,
         "2 Vehicles" = B08201_004E,
         "3 Vehicles" = B08201_005E,
         "4+ Vehicles" = B08201_006E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County", "Caldwell County")) %>%
  dplyr::select(GEOID, NAME, "No Vehicle", "1 Vehicle", "2 Vehicles", "3 Vehicles", "4+ Vehicles")

county17 <- county17 %>% mutate(year = 2017)
county22 <- county22 %>% mutate(year = 2022)

combined_years <- bind_rows(county17, county22)

# PLOT

library(ggplot2)
library(reshape2)

# Subset data for Watauga County
watauga_data <- combined_years %>%
  filter(NAME == "Watauga County")

# Melt the dataset to long format
watauga_data_long <- melt(watauga_data, id.vars = c("year", "NAME", "GEOID"), 
                          measure.vars = c("No Vehicle", "1 Vehicle", "2 Vehicles", "3 Vehicles", "4+ Vehicles"),
                          variable.name = "Vehicle_Category", value.name = "Households")

# Plot histogram
ggplot(watauga_data_long, aes(x = Vehicle_Category, y = Households, fill = factor(year))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Number of Households by Count of Vehicles Owned",
       subtitle = "2017-22" ,
       x = " ",
       y = "# of Households",
       fill = "Year") +
  scale_fill_manual(values = c("#f9bf3e", "#74c1b9"), labels = c("2017", "2022")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## Average Household Size

```{r}
countyHH17 <- 
  get_acs(geography = "county", 
          variables = c("S1101_C01_002"), 
          year=2017, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename("Household_Size" = S1101_C01_002E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County", "Caldwell County")) %>%
  dplyr::select(GEOID, NAME, "Household_Size")

countyHH22 <- 
  get_acs(geography = "county", 
          variables = c("S1101_C01_002"), 
          year=2022, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename("Household_Size" = S1101_C01_002E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County", "Caldwell County")) %>%
  dplyr::select(GEOID, NAME, "Household_Size")


countyHH17 <- countyHH17 %>% mutate(year = 2017)
countyHH22 <- countyHH22 %>% mutate(year = 2022)

combined_yearsHH <- bind_rows(countyHH17, countyHH22)

# plot
ggplot(combined_yearsHH, aes(x = NAME, y = Household_Size, fill = factor(year))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("#f9bf3e", "#74c1b9")) +
  labs(title = "Household Size",
       subtitle = "by county",
       x = " ",
       y = "Household Size",
       fill = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


# Population Size

```{r}
county17pop <- 
  get_acs(geography = "county", 
          variables = c("S0101_C01_001"), 
          year=2017, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename(Population = S0101_C01_001E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County", "Caldwell County")) %>%
  dplyr::select(GEOID, NAME, Population)

county22pop <- 
  get_acs(geography = "county", 
          variables = c("S0101_C01_001"), 
          year=2022, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename(Population = S0101_C01_001E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County", "Caldwell County")) %>%
  dplyr::select(GEOID, NAME, Population)

county17pop <- county17pop %>% mutate(year = 2017)
county22pop <- county22pop %>% mutate(year = 2022)

combined_yearspop <- bind_rows(county17pop, county22pop)


# plot
ggplot(combined_yearspop, aes(x = NAME, y = Population, fill = factor(year))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("#f9bf3e", "#74c1b9")) +
  labs(title = "Population",
       subtitle = "by county",
       x = " ",
       y = "# of people",
       fill = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## Housing by Occupancy Type

```{r}
county17ocup <- 
  get_acs(geography = "county", 
          variables = c("S2501_C01_001",
                        "S2501_C03_001",
                        "S2501_C05_001"
                        ), 
          year=2017, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename(Total = S2501_C01_001E,
        Owner = S2501_C03_001E,
        Renter = S2501_C05_001E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County", "Caldwell County")) %>%
  dplyr::select(GEOID, NAME, Total, Owner, Renter)

county22ocup <- 
  get_acs(geography = "county", 
          variables = c("S2501_C01_001",
                        "S2501_C03_001",
                        "S2501_C05_001"
                        ), 
          year=2022, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename(Total = S2501_C01_001E,
        Owner = S2501_C03_001E,
        Renter = S2501_C05_001E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County", "Caldwell County")) %>%
  dplyr::select(GEOID, NAME, Total, Owner, Renter)

county17ocup <- county17ocup %>% mutate(year = 2017)
county22ocup <- county22ocup %>% mutate(year = 2022)

combined_yearsocup <- bind_rows(county17ocup, county22ocup)


# plot
# long format
combined_yearsocup_long <- pivot_longer(combined_yearsocup, cols = c(Renter, Owner), names_to = "Occupancy", values_to = "Units")

ggplot(combined_yearsocup_long, aes(x = NAME, y = Units, fill = Occupancy)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("#f9bf3e", "#74c1b9")) +
  labs(title = "Housing Units by Occupancy Type",
       x = " ",
       y = "Number of Housing Units",
       fill = "Occupancy") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


# Median Income

```{r}
county17inc <- 
  get_acs(geography = "county", 
          variables = c("S1901_C01_012"), 
          year=2017, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename(Income = S1901_C01_012E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County", "Caldwell County")) %>%
  dplyr::select(GEOID, NAME, Income)

county22inc <- 
  get_acs(geography = "county", 
          variables = c("S1901_C01_012"), 
          year=2022, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename(Income = S1901_C01_012E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County", "Caldwell County")) %>%
  dplyr::select(GEOID, NAME, Income)

county17inc <- county17inc %>% mutate(year = 2017)
county22inc <- county22inc %>% mutate(year = 2022)

combined_yearsinc <- bind_rows(county17inc, county22inc)

# plot
ggplot(combined_yearsinc, aes(x = NAME, y = Income, fill = factor(year))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("#f9bf3e", "#74c1b9")) +
  labs(title = "Median Income",
       subtitle = "by county",
       x = " ",
       y = "income (in $)",
       fill = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


# Median Age

```{r}
county17age <- 
  get_acs(geography = "county", 
          variables = c("S0101_C01_032"), 
          year=2017, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename(Age = S0101_C01_032E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County", "Caldwell County")) %>%
  dplyr::select(GEOID, NAME, Age)

county22age <- 
  get_acs(geography = "county", 
          variables = c("S0101_C01_032"), 
          year=2022, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename(Age = S0101_C01_032E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County", "Caldwell County")) %>%
  dplyr::select(GEOID, NAME, Age)


county17age <- county17age %>% mutate(year = 2017)
county22age <- county22age %>% mutate(year = 2022)

combined_yearsage <- bind_rows(county17age, county22age)

# plot
ggplot(combined_yearsage, aes(x = NAME, y = Age, fill = factor(year))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("#f9bf3e", "#74c1b9")) +
  labs(title = "Median Age",
       subtitle = "by county",
       x = " ",
       y = "age (in years)",
       fill = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## Percent Rent Burdened by Surrounding Counties 

```{r}
county17rent <- 
  get_acs(geography = "county", 
          variables = c("B25070_007E",
                        "B25070_008E",
                        "B25070_009E",
                        "B25070_010E",
                        "B25070_011E",
                        "B25003_003E"), 
          year=2017, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename(RentBurden_30_35 = B25070_007E,
         RentBurden_35_39 = B25070_008E,
         RentBurden_40_49 = B25070_009E,
         RentBurden_50_99 = B25070_010E,
         RentBurden_60_more = B25070_011E,
         total_renter_occupied = B25003_003E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(rent_burdened_households = RentBurden_30_35 + RentBurden_35_39 + RentBurden_40_49 + RentBurden_50_99 + RentBurden_60_more,
         Percent_rent_burdened = round((rent_burdened_households / total_renter_occupied) * 100, 0),
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County","Caldwell County")) %>%
  dplyr::select(GEOID, NAME, rent_burdened_households, total_renter_occupied, Percent_rent_burdened)

county22rent <- 
  get_acs(geography = "county", 
          variables = c("B25070_007E",
                        "B25070_008E",
                        "B25070_009E",
                        "B25070_010E",
                        "B25070_011E",
                        "B25003_003E"), 
          year=2022, state="NC", 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:4326') %>%
  rename(RentBurden_30_35 = B25070_007E,
         RentBurden_35_39 = B25070_008E,
         RentBurden_40_49 = B25070_009E,
         RentBurden_50_99 = B25070_010E,
         RentBurden_60_more = B25070_011E,
         total_renter_occupied = B25003_003E) %>%
  dplyr::select(-starts_with("B")) %>%
  mutate(rent_burdened_households = RentBurden_30_35 + RentBurden_35_39 + RentBurden_40_49 + RentBurden_50_99 + RentBurden_60_more,
         Percent_Burdened = round((rent_burdened_households / total_renter_occupied) * 100, 0),
         NAME = str_replace(NAME, ", North Carolina", "")) %>%
  dplyr::filter(NAME %in% c("Avery County", "Wilkes County", "Ashe County", "Watauga County", "Caldwell County")) %>%
  dplyr::select(GEOID, NAME, rent_burdened_households, total_renter_occupied, Percent_Burdened)

county17rent <- county17rent %>% mutate(year = 2017)
county22rent <- county22rent %>% mutate(year = 2022)

combined_yearsrent <- bind_rows(county17rent, county22rent)


# Reshape the data into longer format
combined_yearsrent_long <- pivot_longer(combined_yearsrent, 
                                        cols = c(Percent_Burdened), 
                                        names_to = "Year", 
                                        values_to = "Percentage")

# Plotting the data
ggplot(combined_yearsrent_long, aes(x = reorder(NAME, -Percentage), y = Percentage, fill = Year)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = c("#f9bf3e"), guide = FALSE) +  # Hide legend
  labs(title = "Percentage of Rent-Burdened Households",
       subtitle = "by county",
       x = " ",
       y = "percentage (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        axis.title.x = element_blank())  # Hiding x-axis label


```

# Maps

```{r}
ggplot(data = county17) +
  geom_sf(aes(fill = Percent_rent_burdened)) + # Removed color = color_palette here
  scale_fill_gradientn(colors = color_palette) + # Use this to apply your color palette
  geom_sf_text(aes(label = NAME), 
               size = 4, # Adjusted size
               colour = "black", 
               check_overlap = TRUE,
               fontface = "bold") + # Make text bold
  geom_sf_text(aes(label = paste0(Percent_rent_burdened, "%")), 
               size = 3.5, # Adjusted size
               colour = "black", 
               check_overlap = TRUE, 
               nudge_y = -0.05,
               fontface = "bold") + # Make text bold
  labs(title = "Rent Burdened Households by County",
       subtitle = "Year: 2017") +
  theme_void() +
  theme(legend.position = "right")
```


```{r}
ggplot(data = county22) +
  geom_sf(aes(fill = Percent_rent_burdened)) + # Removed color = color_palette here
  scale_fill_gradientn(colors = color_palette) + # Use this to apply your color palette
  geom_sf_text(aes(label = NAME), 
               size = 4, # Adjusted size
               colour = "black", 
               check_overlap = TRUE,
               fontface = "bold") + # Make text bold
  geom_sf_text(aes(label = paste0(Percent_rent_burdened, "%")), 
               size = 3.5, # Adjusted size
               colour = "black", 
               check_overlap = TRUE, 
               nudge_y = -0.05,
               fontface = "bold") + # Make text bold
  labs(title = "Rent Burdened Households by County",
       subtitle = "Year: 2022") +
  theme_void() +
  theme(legend.position = "right")
```

```{r read_data}
boundary <- st_read("C:/Users/fatbo/OneDrive/Documents/GitHub/Musa_801_Watauga/GeoJSON/Boundary.geojson")

fire_districts <- st_read("C:/Users/fatbo/OneDrive/Documents/GitHub/Musa_801_Watauga/GeoJSON/FireDistricts_FeaturesToJSON.geojson")

managed_areas <- st_read("C:/Users/fatbo/OneDrive/Documents/GitHub/Musa_801_Watauga/GeoJSON/managed_areasToJSON.geojson")

natural_areas <- st_read("C:/Users/fatbo/OneDrive/Documents/GitHub/Musa_801_Watauga/GeoJSON/Natural_area_JSON.geojson")

zoned_areas <- st_read("C:/Users/fatbo/OneDrive/Documents/GitHub/Musa_801_Watauga/GeoJSON/zonedareas_FeaturesToJSON.geojson")

municipal_bound <- st_read("C:/Users/fatbo/OneDrive/Documents/GitHub/Musa_801_Watauga/GeoJSON/NCDOT_Municipal_Boundaries.geojson")

county_bound <- st_read("C:/Users/fatbo/OneDrive/Documents/GitHub/Musa_801_Watauga/GeoJSON/NCDOT_County_Boundaries.geojson")

# Landcover Vector

legend<-pal_nlcd()

lc_2021 <- raster("C:/Users/fatbo/OneDrive/Documents/GitHub/Musa_801_Watauga/Data/Landuse_Raster/lulc_2021")
lc_2019 <- raster("C:/Users/fatbo/OneDrive/Documents/GitHub/Musa_801_Watauga/Data/Landuse_Raster/lulc_2019")
lc_2016 <- raster("C:/Users/fatbo/OneDrive/Documents/GitHub/Musa_801_Watauga/Data/Landuse_Raster/lulc_2016")
lc_2013 <- raster("C:/Users/fatbo/OneDrive/Documents/GitHub/Musa_801_Watauga/Data/Landuse_Raster/lulc_2013")
lc_2011 <- raster("C:/Users/fatbo/OneDrive/Documents/GitHub/Musa_801_Watauga/Data/Landuse_Raster/lulc_2011")
```

```{r}
ggplot() +
  geom_sf(data = boundary, fill = NA, color = "black") + 
  geom_sf(data = managed_areas, aes(fill = OWNER_TYPE)) + 
  scale_fill_manual(values = color_palette) + 
  labs(title = "Watauga Managed Areas by Owner Type",
       subtitle = "Year: 2022") +
  theme_void() +
  theme(legend.position = "right")
```
```{r}
ggplot() +
  geom_sf(data = boundary, fill = NA, color = "black") + 
  geom_sf(data = natural_areas, aes(fill = C_RATING)) + 
  scale_fill_manual(values = color_palette) + 
  labs(title = "Watauga Natural",
       subtitle = "Year: 2022") +
  theme_void() +
  theme(legend.position = "right")
```

# Land Cover 10 year changes

```{r}
s <- stack(lc_2011, lc_2013, lc_2016,lc_2019, lc_2021 )

vals <-unique(s[[5]])  # Get unique values from lc_2021
df <- legend[legend$ID %in% vals,]  # Filter legend information based on lc_2021 values

rat <- ratify(lc_2011)

myKey <- list(
  rectangles = list(col = df$Color),
  text = list(lab = df$Class),
  space = 'right',
  columns = 1,
  size = 2,
  cex = .6
)
levelplot(rat, att='ID', 
          col.regions=df$Color,
          maxpixels=ncell(rat), # Try setting maxpixels to the number of cells in the raster
          par.settings = list(
            axis.line = list(col = "transparent"), 
            strip.background = list(col = 'transparent'), 
            strip.border = list(col = 'transparent')
          ), 
          scales = list(col = "transparent"),
          colorkey = FALSE,
          key = myKey,
          main = "Watauga 2011 Land Cover") # Title added here

rat2 <- ratify(lc_2013)

levelplot(rat2, att='ID', 
          col.regions=df$Color,
          maxpixels=ncell(rat2), # Try setting maxpixels to the number of cells in the raster
          par.settings = list(
            axis.line = list(col = "transparent"), 
            strip.background = list(col = 'transparent'), 
            strip.border = list(col = 'transparent')
          ), 
          scales = list(col = "transparent"),
          colorkey = FALSE,
          key = myKey,
          main = "Watauga 2013 Land Cover") # Title added here

rat3 <- ratify(lc_2016)

levelplot(rat3, att='ID', 
          col.regions=df$Color,
          maxpixels=ncell(rat3), # Try setting maxpixels to the number of cells in the raster
          par.settings = list(
            axis.line = list(col = "transparent"), 
            strip.background = list(col = 'transparent'), 
            strip.border = list(col = 'transparent')
          ), 
          scales = list(col = "transparent"),
          colorkey = FALSE,
          key = myKey,
          main = "Watauga 2016 Land Cover") # Title added here

rat4 <- ratify(lc_2019)

levelplot(rat4, att='ID', 
          col.regions=df$Color,
          maxpixels=ncell(rat4), # Try setting maxpixels to the number of cells in the raster
          par.settings = list(
            axis.line = list(col = "transparent"), 
            strip.background = list(col = 'transparent'), 
            strip.border = list(col = 'transparent')
          ), 
          scales = list(col = "transparent"),
          colorkey = FALSE,
          key = myKey,
          main = "Watauga 2019 Land Cover") # Title added here

rat5 <- ratify(lc_2021)

levelplot(rat5, att='ID', 
          col.regions=df$Color,
          maxpixels=ncell(rat5), # Try setting maxpixels to the number of cells in the raster
          par.settings = list(
            axis.line = list(col = "transparent"), 
            strip.background = list(col = 'transparent'), 
            strip.border = list(col = 'transparent')
          ), 
          scales = list(col = "transparent"),
          colorkey = FALSE,
          key = myKey,
          main = "Watauga 2021 Land Cover") # Title added here
```


```{r}
years.list <- list("2011", "2013", "2016", "2019", "2021")

saveGIF({
  for(i in 1:nlayers(s)){
    rat <- ratify(s[[i]])
    plot <- levelplot(rat, att='ID',
              maxpixels=ncell(rat),
              col.regions=df$Color,
              par.settings = list(axis.line = list(col = "transparent"), 
                                  strip.background = list(col = 'transparent'), 
                                  strip.border = list(col = 'transparent')), 
              scales = list(col = "transparent"),
              main=paste0("Watauga County land cover ", years.list[[i]]),
              colorkey=FALSE)
    print(plot)
  }
}, interval=1, movie.name="lc_time_series.gif", ani.width=1200, ani.height=900)
```



```{r}
years<-c(2011, 2013, 2016, 2019, 2021)

d<-df
for (i in 1:length(years)) {
  d<-merge(d, freq(s[[i]]), by.x="ID" ,by.y="value", all.y=F, all.x=T)
  names(d)[ncol(d)]<-paste0("pix_", years[[i]])
  }

# Now, a few percent change calculations:

d$square.mile.change<-(d$pix_2021 - d$pix_2011) * 30 * 30 * 0.00000038610
d$percentchange<-(d$pix_2021 - d$pix_2011)/d$pix_2011
d$prop2021<-d$pix_2021/sum(d$pix_2021)

d$percentchange.2011.2021<-paste(round(100*d$percentchange, 2), "%", sep="")
d$percent.area.2021<-paste(round(100*d$prop2021, 2), "%", sep="")

# Make it a pretty table with kable:

kable(d[,c(2,10,13,14)])  %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F)
```